name: Test Templates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-base-template:
    name: Test Base Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create service from base template
        run: |
          echo -e "test-base-service\nA test service\nTest CI\nMIT\n3000\n3001\n>=22.0.0\n/tmp/test-base" | node bin/create-base-service.js

      - name: Install dependencies
        working-directory: /tmp/test-base
        run: npm ci

      - name: Run Biome linter
        working-directory: /tmp/test-base
        run: npm run lint

      - name: Run TypeScript compiler
        working-directory: /tmp/test-base
        run: npm run build

      - name: Run tests
        working-directory: /tmp/test-base
        run: npm test

      - name: Start and stop service
        working-directory: /tmp/test-base
        run: |
          # Start service in background
          npm run dev > /tmp/service.log 2>&1 &
          DEV_PID=$!

          # Wait for service to start (max 30 seconds)
          for i in {1..30}; do
            if curl -f http://localhost:3000/__/health > /dev/null 2>&1; then
              echo "Service started successfully"
              break
            fi
            if ! kill -0 $DEV_PID 2>/dev/null; then
              echo "Service failed to start"
              cat /tmp/service.log
              exit 1
            fi
            sleep 1
          done

          # Verify health endpoint responded
          HEALTH_RESPONSE=$(curl -s http://localhost:3000/__/health)
          echo "Health check response: $HEALTH_RESPONSE"

          # Stop service
          kill $DEV_PID || true
          wait $DEV_PID || true

          echo "Service started and stopped successfully"

  test-postgres-template:
    name: Test Base + Node-PG Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create service from base template
        run: |
          echo -e "test-pg-service\nA test service with PostgreSQL\nTest CI\nMIT\n3000\n3001\n>=22.0.0\n/tmp/test-pg" | node bin/create-base-service.js

      - name: Add PostgreSQL layer
        run: |
          echo -e "/tmp/test-pg\nlocalhost\n5432\n5432\ntestdb\ntestuser\ntestpassword\n1\n10\n30000\n2000" | node bin/add-node-pg-layer.js

      - name: Build custom PostgreSQL image
        working-directory: /tmp/test-pg/docker
        run: docker build -f Dockerfile.postgres -t test-postgres:latest .

      - name: Start PostgreSQL with pg_cron and app.allow_nuke
        run: |
          docker run -d \
            --name test-postgres \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpassword \
            -e POSTGRES_DB=testdb \
            -e PGDATA=/tmp/pgdata \
            -p 5432:5432 \
            --tmpfs /tmp:rw,noexec,nosuid,size=1g \
            test-postgres:latest \
            postgres \
            -c shared_preload_libraries=pg_cron \
            -c cron.database_name=testdb \
            -c app.allow_nuke=true

      - name: Wait for PostgreSQL to be ready
        run: |
          for i in {1..30}; do
            if docker exec test-postgres pg_isready -U testuser > /dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 1
          done

      - name: Install dependencies
        working-directory: /tmp/test-pg
        run: npm ci

      - name: Run Biome linter
        working-directory: /tmp/test-pg
        run: npm run lint

      - name: Run TypeScript compiler
        working-directory: /tmp/test-pg
        run: npm run build

      - name: Run tests
        working-directory: /tmp/test-pg
        run: npm test
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGDATABASE: testdb
          PGUSER: testuser
          PGPASSWORD: testpassword

      - name: Start and stop service
        working-directory: /tmp/test-pg
        run: |
          # Start service in background
          npm run dev > /tmp/service-pg.log 2>&1 &
          DEV_PID=$!

          # Wait for service to start (max 30 seconds)
          for i in {1..30}; do
            if curl -f http://localhost:3000/__/health > /dev/null 2>&1; then
              echo "Service started successfully"
              break
            fi
            if ! kill -0 $DEV_PID 2>/dev/null; then
              echo "Service failed to start"
              cat /tmp/service-pg.log
              exit 1
            fi
            sleep 1
          done

          # Verify health endpoint responded
          HEALTH_RESPONSE=$(curl -s http://localhost:3000/__/health)
          echo "Health check response: $HEALTH_RESPONSE"

          # Stop service
          kill $DEV_PID || true
          wait $DEV_PID || true

          echo "Service started and stopped successfully"
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGDATABASE: testdb
          PGUSER: testuser
          PGPASSWORD: testpassword

      - name: Cleanup PostgreSQL container
        if: always()
        run: docker rm -f test-postgres || true
